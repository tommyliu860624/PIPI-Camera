<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#022c22">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çš®çš®ç›¸æ©Ÿ">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23064e3b' rx='20'/%3E%3Ctext y='55' font-size='50' text-anchor='middle' x='50' dy='.35em'%3EğŸŒ±%3C/text%3E%3C/svg%3E">
    <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23064e3b' rx='20'/%3E%3Ctext y='55' font-size='50' text-anchor='middle' x='50' dy='.35em'%3EğŸŒ±%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23064e3b'/%3E%3Ctext y='55' font-size='50' text-anchor='middle' x='50' dy='.35em'%3EğŸŒ±%3C/text%3E%3C/svg%3E">

    <title>çš®çš®ç›¸æ©Ÿ v7.9 (Network Fix)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: pan-x pan-y;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.6s ease-out forwards; }
        @keyframes print-reveal { 0% { transform: translateY(60px) scale(0.98); opacity: 0; filter: blur(4px); } 100% { transform: translateY(0) scale(1); opacity: 1; filter: blur(0); } }
        .animate-print { animation: print-reveal 2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes toast-in { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        .toast-enter { animation: toast-in 0.3s ease-out forwards; }
        .toast-exit { animation: toast-out 0.3s ease-in forwards; }
        
        .font-mono-tech { font-family: 'Share Tech Mono', monospace; }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        .animate-shake-gentle { animation: shake 2s ease-in-out infinite; }
        
        .tap-feedback:active { transform: scale(0.9); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const BACKGROUND_IMAGES = Array.from({ length: 25 }, (_, i) => `images/pipi_bg (${i + 1}).png`);
        const FALLBACK_IMAGE = "data:image/svg+xml,%3Csvg width='600' height='400' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%25' height='100%25' fill='%23f8fafc'/%3E%3Ccircle cx='550' cy='50' r='100' fill='%23e2e8f0' opacity='0.5'/%3E%3Ccircle cx='50' cy='350' r='80' fill='%23e2e8f0' opacity='0.5'/%3E%3Ctext x='50%25' y='50%25' font-size='16' text-anchor='middle' fill='%2394a3b8' font-family='sans-serif'%3Eè«‹å°‡åœ–ç‰‡æ”¾å…¥ images è³‡æ–™å¤¾%3C/text%3E%3C/svg%3E";

        // ==========================================
        // ğŸ”’ æ™‚é–“é–å®šè¨­å®š
        // ==========================================
        // æ ¼å¼ï¼šYYYY-MM-DDTHH:mm:ss+08:00 (å°åŒ—æ™‚é–“)
        const TARGET_UNLOCK_TIME = "2025-12-31T13:00:00+08:00"; 
        
        // æ™‚é–“ API ä¾†æºåˆ—è¡¨
        const API_PRIMARY = "https://worldtimeapi.org/api/timezone/Asia/Taipei";
        const API_BACKUP = "https://timeapi.io/api/Time/current/zone?timeZone=Asia/Taipei";

        const Fireworks = () => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let particles = [];
                let animationId;
                const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                window.addEventListener('resize', resize);
                resize();
                const createParticle = (x, y, color) => ({ x, y, color, vx: (Math.random() - 0.5) * 4, vy: (Math.random() - 0.5) * 4, alpha: 1, size: Math.random() * 3 + 1 });
                const createExplosion = () => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height * 0.6; 
                    const color = `hsl(${Math.random() * 360}, 100%, 70%)`; 
                    for (let i = 0; i < 30; i++) particles.push(createParticle(x, y, color));
                };
                const animate = () => {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'lighter';
                    particles.forEach((p, index) => {
                        p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.015;
                        ctx.fillStyle = p.color; ctx.globalAlpha = p.alpha; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                        if (p.alpha <= 0) particles.splice(index, 1);
                    });
                    if (Math.random() < 0.05) createExplosion();
                    animationId = requestAnimationFrame(animate);
                };
                animate();
                return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animationId); };
            }, []);
            return <canvas ref={canvasRef} className="absolute inset-0 w-full h-full pointer-events-none z-0 opacity-80" />;
        };

        const convertDMSToDD = (dms, ref) => {
            if (!dms || dms.length < 3) return null;
            let dd = dms[0] + dms[1] / 60 + dms[2] / (60 * 60);
            if (ref === "S" || ref === "W") dd = dd * -1;
            return dd;
        };

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (
                <div className="fixed top-0 left-0 right-0 z-50 p-4 flex justify-center pointer-events-none safe-area-top">
                    <div className="bg-emerald-600 text-white px-6 py-3 rounded-full shadow-xl shadow-emerald-900/50 flex items-center gap-2 toast-enter border border-emerald-400/30">
                        <i data-lucide="check-circle" className="w-5 h-5 text-white"></i>
                        <span className="font-medium text-sm">{message}</span>
                    </div>
                </div>
            );
        };

        const cropToSquare = (imageSrc) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const size = Math.min(img.width, img.height);
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    const sx = (img.width - size) / 2;
                    const sy = (img.height - size) / 2;
                    ctx.drawImage(img, sx, sy, size, size, 0, 0, size, size);
                    resolve(canvas.toDataURL('image/jpeg', 0.95));
                };
                img.src = imageSrc;
            });
        };

        const CountdownDisplay = ({ timeLeft, onSecretTap }) => {
            const safeTimeLeft = timeLeft || { days: 0, hours: 0, minutes: 0, seconds: 0 };
            const { days = 0, hours = 0, minutes = 0, seconds = 0 } = safeTimeLeft;
            
            const TimeBox = ({ val, label }) => (
                <div className="flex flex-col items-center">
                    <div className="w-14 h-16 sm:w-16 sm:h-20 bg-black/40 backdrop-blur-md rounded-lg border border-emerald-500/30 flex items-center justify-center shadow-[inset_0_0_10px_rgba(16,185,129,0.2)]">
                        <span className="text-2xl sm:text-3xl font-mono-tech font-bold text-emerald-300 drop-shadow-[0_0_5px_rgba(52,211,153,0.8)]">
                            {String(val || 0).padStart(2, '0')}
                        </span>
                    </div>
                    <span className="text-[10px] text-emerald-500/60 mt-1 font-bold">{label}</span>
                </div>
            );

            return (
                <div className="w-full mb-8 relative z-10 flex flex-col items-center">
                    <div 
                        onClick={onSecretTap}
                        className="inline-block p-3 rounded-full bg-emerald-900/40 border border-emerald-500/30 backdrop-blur-md mb-4 animate-shake-gentle cursor-pointer tap-feedback active:bg-emerald-800/50"
                    >
                        <i data-lucide="lock" className="w-6 h-6 text-emerald-400"></i>
                    </div>
                    <p className="text-xs text-emerald-300/80 uppercase tracking-widest font-bold mb-4">Coming Soon</p>
                    
                    <div className="flex gap-3 sm:gap-4 justify-center">
                        <TimeBox val={days} label="DAYS" />
                        <TimeBox val={hours} label="HRS" />
                        <TimeBox val={minutes} label="MIN" />
                        <TimeBox val={seconds} label="SEC" />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('camera');
            const [image, setImage] = useState(null);
            const [bgImage, setBgImage] = useState(FALLBACK_IMAGE);
            const [bgImageStatus, setBgImageStatus] = useState('loading');
            const [currentBgPath, setCurrentBgPath] = useState('');
            const [processingText, setProcessingText] = useState("Printing..."); 
            const [locationName, setLocationName] = useState("");
            const [locationDetail, setLocationDetail] = useState("å®šä½ä¸­...");
            const [date, setDate] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [isLoadingLocation, setIsLoadingLocation] = useState(false);
            const [showEdit, setShowEdit] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [browserLocation, setBrowserLocation] = useState(null);
            
            const [isLocked, setIsLocked] = useState(true);
            const [serverOffset, setServerOffset] = useState(0); 
            const [timeLeft, setTimeLeft] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
            const [lockMessage, setLockMessage] = useState("æ­£åœ¨èˆ‡ä¸–ç•Œæ™‚é–“åŒæ­¥...");
            const [tapCount, setTapCount] = useState(0);
            const tapTimeoutRef = useRef(null);

            const cardRef = useRef(null);
            const textCanvasRef = useRef(null);
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);
            const timerRef = useRef(null);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [mode, image, showEdit, toast.show, processingText, isLocked]);

            useEffect(() => {
                checkNetworkTime();
                return () => clearInterval(timerRef.current);
            }, []);

            useEffect(() => {
                if (!isLocked) return;
                const startCountdown = () => {
                    timerRef.current = setInterval(() => {
                        const now = new Date().getTime();
                        const adjustedNow = now + serverOffset; 
                        const target = new Date(TARGET_UNLOCK_TIME).getTime();
                        const diff = target - adjustedNow;

                        if (diff <= 0) {
                            setIsLocked(false);
                            clearInterval(timerRef.current);
                        } else {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                            setTimeLeft({ days, hours, minutes, seconds });
                        }
                    }, 1000);
                };
                startCountdown();
                return () => clearInterval(timerRef.current);
            }, [isLocked, serverOffset]);

            const handleSecretTap = () => {
                if (tapTimeoutRef.current) clearTimeout(tapTimeoutRef.current);
                const newCount = tapCount + 1;
                setTapCount(newCount);
                if (newCount >= 7) {
                    setIsLocked(false); 
                    showToastMessage("ğŸ”“ ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨");
                }
                tapTimeoutRef.current = setTimeout(() => { setTapCount(0); }, 2000);
            };

            const checkNetworkTime = async () => {
                setLockMessage("æ­£åœ¨é€£ç·šè‡³æ™‚é–“ä¼ºæœå™¨...");
                let networkTime = null;

                // 1. å˜—è©¦ä¸»è¦ API (WorldTimeAPI)
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // å»¶é•·è‡³ 8 ç§’
                    const response = await fetch(`${API_PRIMARY}?t=${Date.now()}`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.datetime) {
                            networkTime = new Date(data.datetime).getTime();
                            console.log("Time synced via Primary API");
                        }
                    }
                } catch (err) {
                    console.warn("Primary time API failed, switching to backup...", err);
                }

                // 2. å˜—è©¦å‚™ç”¨ API (TimeAPI.io)
                if (!networkTime) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);
                        const response = await fetch(API_BACKUP, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (response.ok) {
                            const data = await response.json();
                            // timeapi.io å›å‚³æ ¼å¼å¯èƒ½æœ‰ç•°ï¼Œé€™è£¡å‡è¨­å›å‚³ ISO æ ¼å¼æˆ– dateTime æ¬„ä½
                            if (data && data.dateTime) {
                                networkTime = new Date(data.dateTime).getTime();
                                console.log("Time synced via Backup API");
                            }
                        }
                    } catch (err) {
                        console.warn("Backup time API failed.", err);
                    }
                }

                // 3. çµ‚æ¥µå‚™æ¡ˆï¼šä½¿ç”¨æœ¬æ©Ÿç¶²é ä¼ºæœå™¨ Header (è§£æ±º CORS/Network é™åˆ¶)
                if (!networkTime) {
                    try {
                        // åƒ…åœ¨ http/https ä¸‹æœ‰æ•ˆ (é¿å… file:// å ±éŒ¯)
                        if (window.location.protocol.startsWith('http')) {
                            const response = await fetch(window.location.href, { method: 'HEAD' });
                            const dateHeader = response.headers.get('Date');
                            if (dateHeader) {
                                networkTime = new Date(dateHeader).getTime();
                                console.log("Time synced via Server Header");
                            }
                        }
                    } catch (err) {
                        console.warn("Server header time check failed.", err);
                    }
                }

                if (networkTime) {
                    const deviceTime = new Date().getTime();
                    const offset = networkTime - deviceTime;
                    setServerOffset(offset); 
                    const targetTime = new Date(TARGET_UNLOCK_TIME).getTime();
                    if (networkTime >= targetTime) {
                        setIsLocked(false);
                    } else {
                        setIsLocked(true);
                        setLockMessage("è·é›¢è§£é–é‚„æœ‰...");
                    }
                } else {
                    console.error("All time checks failed");
                    // ç‚ºäº†å®‰å…¨ï¼Œè‹¥å®Œå…¨ç„¡æ³•å–å¾—ç¶²è·¯æ™‚é–“ï¼Œå‰‡ç¶­æŒé–å®šä¸¦æç¤º
                    setIsLocked(true); 
                    setLockMessage("ç„¡æ³•å–å¾—ç¶²è·¯æ™‚é–“ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                }
            };

            const showToastMessage = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => {
                    setToast({ show: false, message: '' });
                }, 3000);
            };

            const requestBrowserLocation = () => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setBrowserLocation(position.coords);
                        },
                        (err) => console.warn("Browser location failed"),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                }
            };

            const drawTextOnCanvas = () => {
                const canvas = textCanvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                const scale = 5; 
                canvas.width = canvas.clientWidth * scale;
                canvas.height = canvas.clientHeight * scale;
                ctx.scale(scale, scale);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.clientHeight * 0.4);
                gradient.addColorStop(0, 'rgba(0, 0, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight * 0.4);

                ctx.textBaseline = 'top';
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 1;

                const padding = 10;
                let currentY = padding;

                ctx.font = 'bold 12px "Noto Sans TC", sans-serif';
                const maxWidth = canvas.clientWidth - (padding * 2);
                let title = locationName || "æœªå‘½ååœ°æ¨™";
                if (ctx.measureText(title).width > maxWidth) { ctx.font = 'bold 10px "Noto Sans TC", sans-serif'; }
                ctx.fillText(title, padding, currentY);
                currentY += 18;
                ctx.font = '500 8px "Noto Sans TC", sans-serif';
                const detailText = isLoadingLocation ? "è®€å–ä¸­..." : (locationDetail || "æœªçŸ¥ä½ç½®");
                const dateText = date;
                ctx.fillText(detailText + '   ' + dateText, padding, currentY);
            };

            const shuffleBackground = () => {
                const randomIndex = Math.floor(Math.random() * BACKGROUND_IMAGES.length);
                const selectedPath = BACKGROUND_IMAGES[randomIndex];
                setCurrentBgPath(selectedPath); 
                setBgImageStatus('loading');
                const img = new Image();
                img.onload = () => {
                    setBgImage(selectedPath);
                    setBgImageStatus('loaded');
                };
                img.onerror = () => {
                    console.warn(`Local image missing: ${selectedPath}`);
                    setBgImage(FALLBACK_IMAGE);
                    setBgImageStatus('error');
                };
                img.src = selectedPath;
            };

            const performReverseGeocode = (lat, lon) => {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.address) {
                            const addr = data.address;
                            const suburb = addr.suburb || addr.town || addr.village || addr.neighbourhood || "";
                            const city = addr.city || addr.county || "";
                            let loc = suburb && city ? `${suburb} ${city}` : (city || suburb);
                            if(loc) setLocationDetail(loc);
                            const landmark = addr.building || addr.amenity || addr.tourism || addr.shop;
                            if (landmark) setLocationName(landmark);
                        }
                    })
                    .catch(e => setLocationDetail("ç„¡æ³•è®€å–åœ°å€"))
                    .finally(() => setIsLoadingLocation(false));
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const isCamera = e.target === cameraInputRef.current;

                setMode('processing');
                setProcessingText("æ­£åœ¨å°è£½æ˜ä¿¡ç‰‡..."); 
                shuffleBackground(); 

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const squareImage = await cropToSquare(event.target.result);
                    setImage(squareImage);
                    setTimeout(() => {
                        setProcessingText("âœ¨ å›æ†¶ç´€éŒ„å®Œæˆï¼ âœ¨"); 
                        setTimeout(() => { setMode('result'); }, 2500); 
                    }, 3000); 
                };
                reader.readAsDataURL(file);

                setIsLoadingLocation(true);
                setLocationName("æœªå‘½ååœ°æ¨™");
                setLocationDetail("å®šä½ä¸­...");
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                setDate(today); 

                if (isCamera) {
                    if (browserLocation) { performReverseGeocode(browserLocation.latitude, browserLocation.longitude); } 
                    else if ("geolocation" in navigator) { navigator.geolocation.getCurrentPosition((position) => performReverseGeocode(position.coords.latitude, position.coords.longitude), (err) => { setLocationDetail("è«‹é–‹å•Ÿå®šä½æ¬Šé™"); setIsLoadingLocation(false); }, { enableHighAccuracy: true, timeout: 10000 }); } 
                    else { setLocationDetail("ç„¡æ³•ä½¿ç”¨å®šä½"); setIsLoadingLocation(false); }
                } else {
                    EXIF.getData(file, function() {
                        const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                        if (exifDate) { setDate(exifDate.substring(0, 10).replace(/:/g, '/')); }
                        const latData = EXIF.getTag(this, "GPSLatitude");
                        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                        const lonData = EXIF.getTag(this, "GPSLongitude");
                        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                        if (latData && lonData) {
                            const lat = convertDMSToDD(latData, latRef);
                            const lon = convertDMSToDD(lonData, lonRef);
                            performReverseGeocode(lat, lon);
                        } else { setLocationDetail("ç„¡ä½ç½®è³‡è¨Š"); setIsLoadingLocation(false); }
                    });
                }
            };

            const handleShare = async () => {
                if (!cardRef.current) return;
                setIsGenerating(true);
                await new Promise(r => setTimeout(r, 100));
                try {
                    const canvas = await html2canvas(cardRef.current, { scale: 5, useCORS: true, backgroundColor: null, logging: false });
                    canvas.toBlob(async (blob) => {
                        if (!blob) { setIsGenerating(false); return; }
                        const filename = `pipi_postcard_${Date.now()}.png`;
                        const file = new File([blob], filename, { type: "image/png" });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'çš®çš®æ˜ä¿¡ç‰‡', text: 'çœ‹çœ‹æˆ‘åšçš„æ˜ä¿¡ç‰‡ï¼' }); } catch (err) { console.log("User cancelled share"); } } else { const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL('image/png'); link.click(); showToastMessage("æ˜ä¿¡ç‰‡ä¸‹è¼‰å®Œæˆï¼"); }
                        setIsGenerating(false);
                    }, 'image/png');
                } catch (err) { showToastMessage("è£½ä½œå¤±æ•—ï¼Œè«‹å˜—è©¦æˆªåœ–"); setIsGenerating(false); }
            };

            const resetApp = () => {
                setMode('camera');
                setImage(null);
                setShowEdit(false);
                setBrowserLocation(null); 
                if(cameraInputRef.current) cameraInputRef.current.value = '';
                if(galleryInputRef.current) galleryInputRef.current.value = '';
            };

            return (
                <div className="h-[100dvh] w-full bg-gradient-to-b from-gray-900 via-gray-900 to-emerald-950 flex flex-col relative overflow-hidden text-white">
                    {mode === 'camera' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 z-10 animate-slide-up w-full">
                            <div className="absolute top-0 left-0 w-64 h-64 bg-emerald-500 rounded-full mix-blend-screen filter blur-[80px] opacity-20 animate-blob"></div>
                            <div className="absolute top-0 right-0 w-64 h-64 bg-teal-500 rounded-full mix-blend-screen filter blur-[80px] opacity-20 animate-blob animation-delay-2000"></div>
                            <div className="absolute -bottom-32 left-20 w-80 h-80 bg-green-600 rounded-full mix-blend-screen filter blur-[100px] opacity-20 animate-blob animation-delay-4000"></div>
                            
                            <div className="text-center mb-8 relative z-10">
                                <div className="text-6xl mb-4 animate-float inline-block drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">ğŸŒ±</div>
                                <h1 className="text-4xl font-black tracking-tight text-white mb-2 drop-shadow-md">çš®çš®ç›¸æ©Ÿ</h1>
                                <p className="text-lg text-gray-300 font-medium tracking-wide">èˆ‡çš®çš®ä¸€èµ·ï¼Œ<br/>æ”¶è—ä¸–ç•Œçš„æ¯å€‹è§’è½</p>
                            </div>

                            {isLocked ? (
                                <>
                                    <CountdownDisplay timeLeft={timeLeft} onSecretTap={handleSecretTap} />
                                    <p className="text-center text-xs text-gray-500/80 mb-4">{lockMessage}</p>
                                    {lockMessage.includes("ç„¡æ³•") && (
                                        <button onClick={checkNetworkTime} className="mx-auto block px-4 py-2 bg-gray-800/60 rounded-full text-xs text-gray-300 border border-white/10 hover:bg-gray-700 transition-colors">âŸ³ é‡æ–°é€£ç·š</button>
                                    )}
                                </>
                            ) : (
                                <div className="text-center mb-8 animate-pop">
                                    <div className="inline-block p-4 rounded-full bg-emerald-500/20 mb-2">
                                        <div className="text-6xl">ğŸŒ·</div>
                                    </div>
                                    <p className="text-emerald-300 font-bold">å·²è§£é–ï¼é–‹å§‹ç´€éŒ„å§</p>
                                </div>
                            )}

                            {!isLocked && (
                                <div className="w-full max-w-sm space-y-4 relative z-10 animate-slide-up">
                                    <input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} />
                                    <input type="file" accept="image/*" ref={galleryInputRef} className="hidden" onChange={handleImageUpload} />
                                    <button onClick={() => { requestBrowserLocation(); cameraInputRef.current.click(); }} className="w-full bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/20 text-white py-5 px-6 rounded-2xl flex items-center gap-4 transition-all transform active:scale-95 group shadow-lg shadow-black/20">
                                        <div className="w-12 h-12 bg-emerald-900/50 rounded-full flex items-center justify-center text-emerald-400 border border-emerald-500/30 group-hover:scale-110 transition-transform"><i data-lucide="camera" className="w-6 h-6"></i></div>
                                        <div className="text-left"><h3 className="font-bold text-lg">æ‹æ”æ–°ç…§ç‰‡</h3><p className="text-xs text-gray-400">æ•æ‰ç•¶ä¸‹çš„ç¾å¥½ç¬é–“</p></div>
                                        <i data-lucide="chevron-right" className="ml-auto w-5 h-5 text-gray-500"></i>
                                    </button>
                                    <button onClick={() => { galleryInputRef.current.click(); }} className="w-full bg-gray-800/40 backdrop-blur-md border border-white/10 hover:bg-gray-700/40 text-gray-200 py-5 px-6 rounded-2xl flex items-center gap-4 transition-all transform active:scale-95 group shadow-lg shadow-black/20">
                                        <div className="w-12 h-12 bg-slate-800/50 rounded-full flex items-center justify-center text-slate-400 border border-slate-600/30 group-hover:scale-110 transition-transform"><i data-lucide="image" className="w-6 h-6"></i></div>
                                        <div className="text-left"><h3 className="font-bold text-lg">å¾ç›¸ç°¿æŒ‘é¸</h3><p className="text-xs text-gray-500">è£½ä½œå›æ†¶æ˜ä¿¡ç‰‡</p></div>
                                        <i data-lucide="chevron-right" className="ml-auto w-5 h-5 text-gray-600"></i>
                                    </button>
                                </div>
                            )}
                            <div className="absolute bottom-4 left-0 right-0 text-center text-xs text-gray-500 font-mono safe-area-bottom">PIPI CAM v7.9</div>
                        </div>
                    )}

                    {mode === 'processing' && (
                        <div className="flex-1 flex flex-col items-center justify-center relative transition-all duration-500 bg-gray-950 z-20">
                            <div className="relative w-32 h-32 flex items-center justify-center mb-8">
                                {processingText === "æ­£åœ¨å°è£½æ˜ä¿¡ç‰‡..." ? (
                                    <>
                                        <div className="absolute inset-0 border-4 border-gray-800 rounded-full"></div>
                                        <div className="absolute inset-0 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span className="text-4xl animate-bounce">ğŸŒ±</span>
                                    </>
                                ) : (
                                    <div className="animate-float">
                                        <i data-lucide="check-circle" className="w-20 h-20 text-emerald-400 drop-shadow-[0_0_15px_rgba(52,211,153,0.5)]"></i>
                                    </div>
                                )}
                            </div>
                            <h2 className="text-xl font-bold text-white tracking-widest uppercase animate-slide-up" key={processingText}>{processingText}</h2>
                            {processingText === "æ­£åœ¨å°è£½æ˜ä¿¡ç‰‡..." && (
                                <p className="mt-2 text-xs text-emerald-500 animate-pulse">
                                    {locationDetail === "å®šä½ä¸­..." ? "GPS å®šä½ä¸­..." : `ğŸ“ ${locationDetail}`}
                                </p>
                            )}
                        </div>
                    )}

                    {mode === 'result' && (
                        <>
                            <Toast message={toast.message} show={toast.show} />
                            <Fireworks />
                            <div className="absolute top-0 left-0 right-0 p-4 pt-2 mt-2 z-20 flex justify-end items-start safe-area-top pointer-events-none"></div>
                            <div className="flex-1 flex flex-col items-center justify-center p-6 z-10 w-full max-w-md mx-auto">
                                <div className="w-full shadow-2xl shadow-black/50 rounded-xl overflow-hidden transform transition-all ring-1 ring-white/10 animate-print mb-6">
                                     <div 
                                        ref={cardRef}
                                        className="relative w-full bg-white overflow-hidden"
                                        style={{ 
                                            aspectRatio: '3/2',
                                            backgroundImage: isCssBg ? 'none' : `url("${bgImage}")`,
                                            backgroundSize: 'cover',
                                            backgroundPosition: 'center',
                                            backgroundColor: 'white'
                                        }}
                                    >
                                        {isCssBg && (
                                            <div className="absolute bottom-0 left-0 right-0 h-[3%] bg-gradient-to-r from-[#8ad7ff] via-[#ffe35e] to-[#ff8a8a] opacity-80 z-0"></div>
                                        )}
                                        <div className="absolute top-[4%] right-[4%] z-20 w-[18%] aspect-square opacity-80 pointer-events-none transform rotate-12">
                                            <svg viewBox="0 0 100 100" className="w-full h-full">
                                                <circle cx="50" cy="50" r="46" fill="none" stroke="#b91c1c" strokeWidth="2" />
                                                <circle cx="50" cy="50" r="34" fill="none" stroke="#b91c1c" strokeWidth="1" />
                                                <path id="textPathTop" d="M 14,50 A 36,36 0 0,1 86,50" fill="none" />
                                                <text fill="#b91c1c" fontSize="9" fontWeight="900" letterSpacing="1" fontFamily="Arial Black, sans-serif"><textPath href="#textPathTop" startOffset="50%" textAnchor="middle">PIPI CAMERA</textPath></text>
                                                <path id="textPathBottom" d="M 14,50 A 36,36 0 0,0 86,50" fill="none" />
                                                <text fill="#b91c1c" fontSize="10" fontWeight="bold"><textPath href="#textPathBottom" startOffset="50%" textAnchor="middle">â˜… â˜… â˜…</textPath></text>
                                                <text x="50" y="58" textAnchor="middle" fill="#b91c1c" fontSize="30" fontFamily="Times New Roman, serif" fontWeight="bold">11<tspan fontSize="12" dy="-10">th</tspan></text>
                                                <text x="50" y="74" textAnchor="middle" fill="#b91c1c" fontSize="6" fontFamily="Arial, sans-serif" fontWeight="bold" letterSpacing="0.5">ANNIVERSARY</text>
                                            </svg>
                                        </div>
                                        <div className="absolute inset-0 flex p-[4%] items-center z-10">
                                            <div className="relative h-full aspect-square bg-gray-200 rounded-lg overflow-hidden flex-shrink-0 shadow-md border-2 border-white/50">
                                                <img src={image} className="w-full h-full object-contain bg-black" alt="Captured" />
                                                <canvas ref={textCanvasRef} className="absolute top-0 left-0 w-full h-full pointer-events-none" />
                                            </div>
                                            <div className="flex-1 h-full"></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="pointer-events-auto">
                                    <button 
                                        onClick={() => setShowEdit(!showEdit)} 
                                        className={`px-6 py-2.5 rounded-full shadow-lg flex items-center gap-2 transition-all transform active:scale-95 border border-white/10 ${showEdit ? 'bg-emerald-600 text-white ring-2 ring-emerald-400/50' : 'bg-gray-800/80 backdrop-blur text-gray-200 hover:bg-gray-700'}`}
                                    >
                                        <i data-lucide="pencil" className="w-4 h-4"></i>
                                        <span className="text-sm font-bold">ç·¨è¼¯åœ°é»èˆ‡æ™‚é–“</span>
                                    </button>
                                </div>
                                {bgImageStatus === 'error' && <div className="mt-2 bg-white/10 backdrop-blur-sm text-gray-400 text-[10px] px-3 py-1 rounded-full animate-pulse border border-white/5">é è¦½æ¨¡å¼ (ç„¡æœ¬åœ°åœ–ç‰‡)</div>}
                            </div>
                            {showEdit && (
                                <div className="absolute bottom-24 left-4 right-4 bg-gray-800/90 backdrop-blur rounded-xl p-4 shadow-xl z-20 animate-slide-up border border-white/10">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="text-xs font-bold text-gray-400">ç·¨è¼¯è³‡è¨Š</h3>
                                        <button onClick={() => setShowEdit(false)} className="bg-emerald-600 text-white text-xs px-3 py-1 rounded-full font-bold hover:bg-emerald-500 transition-colors shadow-sm">å®Œæˆ</button>
                                    </div>
                                    <div className="space-y-2">
                                        <input type="text" value={locationName} onChange={(e)=>setLocationName(e.target.value)} placeholder="åœ°æ¨™åç¨±" className="w-full p-2 bg-gray-900 text-white rounded border border-gray-600 text-sm focus:border-emerald-500 focus:outline-none" />
                                        <div className="flex gap-2">
                                            <input type="text" value={locationDetail} onChange={(e)=>setLocationDetail(e.target.value)} placeholder="å€åŸŸ" className="w-full p-2 bg-gray-900 text-white rounded border border-gray-600 text-sm focus:border-emerald-500 focus:outline-none" />
                                            <input type="text" value={date} onChange={(e)=>setDate(e.target.value)} className="w-1/3 p-2 bg-gray-900 text-white rounded border border-gray-600 text-sm text-center focus:border-emerald-500 focus:outline-none" />
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div className="p-6 pb-8 bg-gray-900 safe-area-bottom shadow-[0_-4px_20px_rgba(0,0,0,0.3)] rounded-t-3xl z-30 flex gap-3 relative border-t border-white/5 w-full">
                                <button onClick={resetApp} className="flex-1 py-4 bg-gray-800 text-gray-200 rounded-2xl font-bold flex items-center justify-center gap-2 text-lg active:scale-95 transition-transform hover:bg-gray-700">
                                    <i data-lucide="rotate-ccw" className="w-5 h-5"></i>
                                    é‡æ–°æ‹æ”
                                </button>
                                <button onClick={handleShare} disabled={isGenerating} className={`flex-[2] py-4 rounded-2xl font-bold text-white shadow-lg shadow-emerald-900/50 flex items-center justify-center gap-2 text-lg active:scale-95 transition-transform ${isGenerating ? 'bg-gray-700' : 'bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-500 hover:to-teal-600'}`}>
                                    {isGenerating ? (<><i data-lucide="loader-2" className="w-6 h-6 animate-spin"></i>è™•ç†ä¸­...</>) : (<><i data-lucide="download" className="w-6 h-6"></i>ä¸‹è¼‰æ˜ä¿¡ç‰‡</>)}
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
